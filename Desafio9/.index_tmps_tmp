/* eslint-disable react-hooks/exhaustive-deps */
import React, { useState, useEffect } from 'react';
import { toast } from 'react-toastify';
import { parseISO, format } from 'date-fns';

import { FaPlus } from 'react-icons/fa';

import api from '~/services/api';
import history from '~/services/history';

import {
  Container,
  Title,
  DataHeader,
  Data,
  NoData,
  Paginator,
  Status,
} from './styles';

export default function Deliveries() {
  const [product, setProduct] = useState();
  const [deliveries, setDeliveries] = useState([]);
  const [lastPage, setLastPage] = useState(false);
  const [page, setPage] = useState(1);

  useEffect(() => {
    // eslint-disable-next-line no-use-before-define
    loadDeliveries(1);
  }, []);

  async function loadDeliveries(currentPage) {
    try {
      const { data } = await api.get('deliveries', {
        params: { q: product, page: currentPage },
      });

      const d = data.map(item => {
        let statusText = '';
        let delivered = false;
        let pending = false;
        let withdrawal = false;
        let canceled = false;

        if (item.canceled_at) {
          statusText = 'CANCELADA';
          canceled = true;
        } else if (item.start_date && !item.end_date) {
          statusText = 'RETIRADA';
          withdrawal = true;
        } else if (item.end_date) {
          statusText = 'ENTREGUE';
          delivered = true;
        } else {
          statusText = 'PENDENTE';
          pending = true;
        }

        item.start_date = item.start_date
          ? format(parseISO(item.start_date), 'dd/MM/yyyy')
          : null;
        item.end_date = item.end_date
          ? format(parseISO(item.end_date), 'dd/MM/yyyy')
          : null;

        return {
          ...item,
          showMenu: false,
          statusText,
          canceled,
          delivered,
          pending,
          withdrawal,
        };
      });

      setPage(currentPage);
      setLastPage(data.lastPage);
      setDeliveries(data.content);
    } catch (err) {
      toast.error(err.response.data.error);
    }
  }

  function handleProductChange(e) {
    setProduct(e.target.value);
  }

  function handlePreviousPageChange() {
    const currentPage = page - 1;
    loadDeliveries(currentPage);
  }

  function handleNextPageChange() {
    const currentPage = page + 1;
    loadDeliveries(currentPage);
  }

  return (
    <Container>
      <Title>
        <strong>Gerenciando encomendas</strong>
      </Title>

      <DataHeader>
        <span>
          <input
            name="product"
            placeholder="Buscar por encomendas"
            onKeyDown={event => event.key === 'Enter' && loadDeliveries(1)}
            onChange={handleProductChange}
          />
        </span>

        <button type="button" onClick={() => history.push('/deliveries/new')}>
          <FaPlus color="#FFF" size={16} />
          <span>CADASTRAR</span>
        </button>
      </DataHeader>

      {deliveries.length ? (
        <>
          <Data>
            <thead>
              <tr>
                <th>ID</th>
                <th>Destinatário</th>
                <th>Entregador</th>
                <th>Cidade</th>
                <th>Estado</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {deliveries.map(delivery => (
                <tr key={delivery.id}>
                  <td>#{delivery.id}</td>
                  <td>{delivery.recipient.nome}</td>
                  <td>{delivery.deliveryman.name}</td>

                  <td>{delivery.recipient.cidade}</td>
                  <td>{delivery.recipient.estado}</td>
                  <td>
                    <Status
                      canceled={delivery.canceled}
                      delivered={delivery.delivered}
                      pending={!delivery.pending}
                    >
                      <span>{delivery.statusText}</span>
                    </Status>
                  </td>
                  <td />
                </tr>
              ))}
            </tbody>
          </Data>

          <Paginator>
            <button
              type="button"
              disabled={page === 1}
              onClick={() => {
                handlePreviousPageChange();
              }}
            >
              Anterior
            </button>
            <button
              disabled={lastPage}
              type="button"
              onClick={() => {
                handleNextPageChange();
              }}
            >
              Próxima
            </button>
          </Paginator>
        </>
      ) : (
        <NoData>
          <span>Nenhuma entrega encontrada</span>
        </NoData>
      )}
    </Container>
  );
}
